<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meds-app - Gestión Completa de Medicamentos</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f0f8ff;color:#333;line-height:1.6}
.container{max-width:900px;margin:0 auto;padding:20px}
.header{background:linear-gradient(135deg,#2563EB,#1E3A8A);color:white;padding:30px;border-radius:20px;text-align:center;margin-bottom:30px;box-shadow:0 6px 20px rgba(0,0,0,0.2)}
.header h1{font-size:2.8em;margin-bottom:10px}
.header p{font-size:1.3em;opacity:0.9}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:30px 0}
.stat-card{background:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.1);transition:transform 0.3s}
.stat-card:hover{transform:translateY(-5px)}
.stat-number{font-size:2.8em;font-weight:bold;color:#2563EB;margin-bottom:8px}
.medication-card{background:white;padding:25px;border-radius:15px;margin:15px 0;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:flex-start}
.med-info{flex:1}
.med-name{font-size:1.4em;font-weight:bold;color:#2563EB;margin-bottom:8px}
.med-dose{color:#666;font-size:1.1em;margin-bottom:5px}
.med-time{color:#10b981;font-weight:bold;background:#ecfdf5;padding:5px 10px;border-radius:20px;font-size:0.9em;margin:5px 0}
.btn{background:#2563EB;color:white;border:none;padding:15px 25px;border-radius:12px;cursor:pointer;font-size:1.1em;font-weight:bold;transition:all 0.3s;margin:5px}
.btn:hover{background:#1e40af;transform:translateY(-2px);box-shadow:0 4px 12px rgba(37,99,235,0.3)}
.btn-success{background:#10b981}
.btn-success:hover{background:#059669}
.btn-danger{background:#dc2626}
.btn-danger:hover{background:#b91c1c}
.btn-warning{background:#f59e0b}
.btn-warning:hover{background:#d97706}
.btn-secondary{background:#6b7280}
.btn-secondary:hover{background:#4b5563}
.add-btn{background:linear-gradient(135deg,#10b981,#059669);padding:20px 40px;font-size:1.4em;display:block;margin:30px auto;border-radius:15px;box-shadow:0 6px 20px rgba(16,185,129,0.3)}
.nav{position:fixed;bottom:0;left:0;right:0;background:white;padding:15px;display:flex;justify-content:space-around;box-shadow:0 -4px 15px rgba(0,0,0,0.15);z-index:1000}
.nav-btn{background:none;border:none;padding:12px;cursor:pointer;text-align:center;color:#666;border-radius:12px;transition:all 0.3s;min-width:80px}
.nav-btn.active{color:#2563EB;font-weight:bold;background:#e0f2fe;transform:translateY(-3px)}
.nav-btn:hover{background:#f0f9ff;color:#2563EB}
.nav-btn i{font-size:1.4em;display:block;margin-bottom:5px}
.content-section{display:none}
.content-section.active{display:block}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:20px}
.section-header h2{color:#2563EB;font-size:2.2em}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:white;padding:40px;border-radius:25px;max-width:500px;width:90%;box-shadow:0 15px 35px rgba(0,0,0,0.2);animation:modalSlideIn 0.3s ease-out}
@keyframes modalSlideIn{from{opacity:0;transform:translateY(-50px) scale(0.9)}to{opacity:1;transform:translateY(0) scale(1)}}
.modal-content h3{color:#2563EB;font-size:1.8em;margin-bottom:25px;text-align:center}
.form-group{margin:25px 0}
.form-group label{display:block;margin-bottom:10px;font-weight:bold;color:#2563EB;font-size:1.1em}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:15px;border:2px solid #ddd;border-radius:12px;font-size:1.1em;transition:border-color 0.3s}
.form-group input:focus,.form-group textarea:focus,.form-group select:focus{border-color:#2563EB;outline:none;box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
.modal-buttons{display:flex;gap:15px;justify-content:center;margin-top:30px}
.taken{background:#dcfce7;border-left:5px solid #10b981}
.taken .btn{display:none}
.taken .med-name{color:#10b981}
.medications-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.medication-grid-card{background:white;padding:25px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.medication-actions{display:flex;gap:10px;margin-top:15px}
.filter-btn{background:white;border:2px solid #ddd;color:#666;padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s}
.filter-btn.active,.filter-btn:hover{background:#2563EB;color:white;border-color:#2563EB}
.contact-card{background:white;padding:20px;border-radius:12px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center}
.contact-info{flex:1}
.contact-name{font-weight:bold;color:#2563EB;margin-bottom:5px}
.contact-phone{color:#666}
.contact-relationship{color:#10b981;font-size:0.9em}
.contact-actions{display:flex;gap:10px}
.emergency-section{background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:30px;border-radius:20px;text-align:center;margin:20px 0}
.emergency-btn{background:#fff;color:#dc2626;border:none;padding:20px 40px;border-radius:50px;font-size:1.3em;font-weight:bold;cursor:pointer;animation:pulse 2s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
.sos-btn{position:fixed;top:20px;right:20px;background:#dc2626;color:white;border:none;padding:15px 20px;border-radius:50px;font-weight:bold;z-index:1001;box-shadow:0 4px 15px rgba(220,38,38,0.4);cursor:pointer}
.sos-btn:hover{background:#b91c1c;transform:scale(1.1)}
.toast{position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:20px 25px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.2);z-index:3000;display:flex;align-items:center;gap:15px;font-weight:bold;animation:toastSlideIn 0.3s}
.toast.error{background:#dc2626}
@keyframes toastSlideIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.chart-container{background:white;padding:30px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin:20px 0;max-height:400px;overflow:hidden}
.empty-state{text-align:center;padding:60px;color:#666}
.empty-state i{font-size:4em;margin-bottom:20px;color:#ddd}
.profile-form{background:white;padding:30px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.tabs{display:flex;background:#f3f4f6;border-radius:12px;padding:5px;margin-bottom:25px}
.tab-btn{flex:1;background:none;border:none;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s}
.tab-btn.active{background:#2563EB;color:white}
.tab-content{display:none}
.tab-content.active{display:block}

/* DIAGNÓSTICO */
.debug-info{position:fixed;top:5px;left:5px;background:#ffeb3b;color:#333;padding:10px;border-radius:5px;font-size:12px;z-index:9999;max-width:300px}
@media(max-width:768px){.container{padding:15px}.stats{grid-template-columns:1fr}.medication-card{flex-direction:column;text-align:center}.med-info{margin-bottom:15px}.nav{justify-content:space-around}.modal-content{padding:25px}.sos-btn{top:10px;right:10px;padding:12px 15px}}
</style>
</head>
<body>
<!-- DIAGNÓSTICO -->
<div id="debug-info" class="debug-info">Debug: <span id="debug-status">Iniciando...</span></div>

<button class="sos-btn" onclick="showSOSModal()">
    <i class="fas fa-exclamation-triangle"></i> SOS
</button>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-pills"></i> Meds-app</h1>
        <p>Gestión Completa de Medicamentos para Personas Mayores</p>
    </div>
    
    <!-- SECCIÓN HOY -->
    <section id="today-section" class="content-section active">
        <div class="section-header">
            <h2><i class="fas fa-calendar-day"></i> Medicamentos de Hoy</h2>
            <p id="today-date" style="color:#666;font-size:1.2em"></p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="taken-count">0</div>
                <div>Medicamentos Tomados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-count">3</div>
                <div>Por Tomar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="missed-count">0</div>
                <div>Perdidos</div>
            </div>
        </div>
        
        <div id="today-medications-list">
            <!-- Se carga dinámicamente -->
        </div>
    </section>

    <!-- SECCIÓN MEDICINAS -->
    <section id="medicines-section" class="content-section">
        <div class="section-header">
            <h2><i class="fas fa-pills"></i> Mis Medicamentos</h2>
            <button class="btn add-btn" onclick="showAddMedicationModal()">
                <i class="fas fa-plus"></i> Agregar Medicamento
            </button>
        </div>
        
        <div class="medications-filters" style="margin-bottom:25px">
            <button class="filter-btn active" onclick="filterMedications('all')">Todos</button>
            <button class="filter-btn" onclick="filterMedications('active')">Activos</button>
            <button class="filter-btn" onclick="filterMedications('expiring')">Por Vencer</button>
            <button class="filter-btn" onclick="filterMedications('expired')">Vencidos</button>
        </div>
        
        <div id="medicines-grid" class="medications-grid">
            <!-- Se carga dinámicamente -->
        </div>
    </section>

    <!-- SECCIÓN REPORTES -->
    <section id="reports-section" class="content-section">
        <div class="section-header">
            <h2><i class="fas fa-chart-line"></i> Reportes y Estadísticas</h2>
        </div>
        
        <div class="chart-container">
            <h3 style="margin-bottom:20px;color:#2563EB">Adherencia al Tratamiento</h3>
            <div id="adherence-text">
                <!-- Se carga dinámicamente -->
            </div>
        </div>
        
        <div class="chart-container">
            <h3 style="margin-bottom:20px;color:#2563EB">Medicamentos Tomados Esta Semana</h3>
            <div id="weekly-stats">
                <!-- Se carga dinámicamente -->
            </div>
        </div>
        
        <div class="chart-container">
            <h3 style="margin-bottom:20px;color:#2563EB">Alertas Importantes</h3>
            <div id="alerts-list">
                <!-- Se carga dinámicamente -->
            </div>
        </div>
    </section>

    <!-- SECCIÓN PERFIL -->
    <section id="profile-section" class="content-section">
        <div class="section-header">
            <h2><i class="fas fa-user"></i> Mi Perfil</h2>
        </div>
        
        <div class="profile-form">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('patient-info')">Información Personal</button>
                <button class="tab-btn" onclick="switchTab('emergency-contacts')">Contactos de Emergencia</button>
                <button class="tab-btn" onclick="switchTab('medical-contacts')">Contactos Médicos</button>
                <button class="tab-btn" onclick="switchTab('family-tracking')">Seguimiento Familiar</button>
            </div>
            
            <div id="patient-info-tab" class="tab-content active">
                <h3 style="margin-bottom:20px;color:#2563EB">Información Personal</h3>
                <form id="patient-form">
                    <div class="form-group">
                        <label for="patient-name">Nombre Completo</label>
                        <input type="text" id="patient-name" placeholder="Ej: María González">
                    </div>
                    <div class="form-group">
                        <label for="patient-age">Edad</label>
                        <input type="number" id="patient-age" placeholder="Ej: 65">
                    </div>
                    <div class="form-group">
                        <label for="patient-conditions">Condiciones Médicas</label>
                        <textarea id="patient-conditions" placeholder="Ej: Diabetes tipo 2, Hipertensión" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar Información
                    </button>
                </form>
            </div>
            
            <div id="emergency-contacts-tab" class="tab-content">
                <h3 style="margin-bottom:20px;color:#2563EB">Contactos de Emergencia</h3>
                <div id="emergency-contacts-list">
                    <!-- Se carga dinámicamente -->
                </div>
                <button class="btn add-btn" onclick="showAddContactModal('emergency')">
                    <i class="fas fa-plus"></i> Agregar Contacto de Emergencia
                </button>
            </div>
            
            <div id="medical-contacts-tab" class="tab-content">
                <h3 style="margin-bottom:20px;color:#2563EB">Contactos Médicos</h3>
                <div id="medical-contacts-list">
                    <!-- Se carga dinámicamente -->
                </div>
                <button class="btn add-btn" onclick="showAddContactModal('medical')">
                    <i class="fas fa-plus"></i> Agregar Contacto Médico
                </button>
            </div>
            
            <div id="family-tracking-tab" class="tab-content">
                <h3 style="margin-bottom:20px;color:#2563EB">Seguimiento Familiar</h3>
                <p style="margin-bottom:20px;color:#666">Comparte tu progreso con familiares de confianza</p>
                <div id="family-contacts-list">
                    <!-- Se carga dinámicamente -->
                </div>
                <button class="btn add-btn" onclick="showAddContactModal('family')">
                    <i class="fas fa-plus"></i> Agregar Familiar
                </button>
            </div>
        </div>
    </section>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchSection('today')">
        <i class="fas fa-calendar-day"></i>
        <div>Hoy</div>
    </button>
    <button class="nav-btn" onclick="switchSection('medicines')">
        <i class="fas fa-pills"></i>
        <div>Medicinas</div>
    </button>
    <button class="nav-btn" onclick="switchSection('reports')">
        <i class="fas fa-chart-line"></i>
        <div>Reportes</div>
    </button>
    <button class="nav-btn" onclick="switchSection('profile')">
        <i class="fas fa-user"></i>
        <div>Perfil</div>
    </button>
</div>

<!-- MODALES -->
<!-- Agregar Medicamento -->
<div id="add-medication-modal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-plus"></i> Agregar Medicamento</h3>
        <form id="medication-form">
            <div class="form-group">
                <label for="med-name">Nombre del Medicamento</label>
                <input type="text" id="med-name" placeholder="Ej: Ibuprofeno" required>
            </div>
            <div class="form-group">
                <label for="med-dose">Dosis</label>
                <input type="text" id="med-dose" placeholder="Ej: 400mg" required>
            </div>
            <div class="form-group">
                <label for="med-frequency">Frecuencia</label>
                <select id="med-frequency" required>
                    <option value="">Seleccionar...</option>
                    <option value="daily">Diario</option>
                    <option value="twice-daily">Dos veces al día</option>
                    <option value="weekly">Semanal</option>
                    <option value="as-needed">Según necesidad</option>
                </select>
            </div>
            <div class="form-group">
                <label for="med-time">Hora</label>
                <input type="time" id="med-time" required>
            </div>
            <div class="form-group">
                <label for="med-instructions">Instrucciones</label>
                <textarea id="med-instructions" placeholder="Ej: Tomar con comida" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="med-expiry">Fecha de Vencimiento (Opcional)</label>
                <input type="date" id="med-expiry">
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('add-medication-modal')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Agregar Contacto -->
<div id="add-contact-modal" class="modal">
    <div class="modal-content">
        <h3 id="contact-modal-title"><i class="fas fa-plus"></i> Agregar Contacto</h3>
        <form id="contact-form">
            <div class="form-group">
                <label for="contact-name">Nombre</label>
                <input type="text" id="contact-name" placeholder="Ej: Dr. Juan Pérez" required>
            </div>
            <div class="form-group">
                <label for="contact-phone">Teléfono</label>
                <input type="tel" id="contact-phone" placeholder="Ej: +1234567890" required>
            </div>
            <div class="form-group">
                <label for="contact-relationship">Relación</label>
                <select id="contact-relationship" required>
                    <option value="">Seleccionar...</option>
                    <option value="family">Familiar</option>
                    <option value="friend">Amigo</option>
                    <option value="doctor">Doctor</option>
                    <option value="nurse">Enfermera</option>
                    <option value="pharmacy">Farmacia</option>
                    <option value="other">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contact-notes">Notas Adicionales</label>
                <textarea id="contact-notes" placeholder="Ej: Médico de cabecera" rows="3"></textarea>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('add-contact-modal')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- SOS Modal -->
<div id="sos-modal" class="modal">
    <div class="modal-content">
        <div class="emergency-section">
            <h2><i class="fas fa-exclamation-triangle"></i> EMERGENCIA</h2>
            <p>Selecciona un contacto para llamar</p>
        </div>
        <div id="sos-contacts-list" style="margin-top:20px">
            <!-- Se carga dinámicamente -->
        </div>
        <div style="text-align:center;margin-top:25px">
            <button class="btn emergency-btn" onclick="callEmergency('911')">
                <i class="fas fa-phone"></i> Llamar 911
            </button>
        </div>
        <div style="text-align:center;margin-top:15px">
            <button class="btn btn-secondary" onclick="closeModal('sos-modal')">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>
</div>

<script>
// SISTEMA DE DIAGNÓSTICO
function debugLog(message) {
    const debugElement = document.getElementById('debug-status');
    if (debugElement) {
        debugElement.textContent = message;
        console.log('DEBUG:', message);
    }
}

// Datos de la aplicación
let appData = {
    medications: [
        { 
            id: 'metformin', 
            name: 'Metformin', 
            dose: '500mg', 
            frequency: 'daily',
            time: '08:00',
            instructions: 'Tomar con comida', 
            taken: false,
            expiry: '2025-06-15'
        },
        { 
            id: 'amlodipine', 
            name: 'Amlodipine', 
            dose: '5mg', 
            frequency: 'daily',
            time: '09:00',
            instructions: 'Tomar por la mañana', 
            taken: false,
            expiry: '2025-08-20'
        },
        { 
            id: 'vitamin', 
            name: 'Vitamin D3', 
            dose: '1000 IU', 
            frequency: 'daily',
            time: '12:00',
            instructions: 'Tomar con almuerzo', 
            taken: false,
            expiry: '2025-05-30'
        }
    ],
    contacts: {
        emergency: [
            { id: '1', name: 'María González', phone: '+1234567890', relationship: 'Hija', notes: 'Contacto principal' },
            { id: '2', name: 'Dr. Juan Pérez', phone: '+1234567891', relationship: 'doctor', notes: 'Médico de cabecera' }
        ],
        medical: [
            { id: '1', name: 'Dr. Juan Pérez', phone: '+1234567891', relationship: 'doctor', notes: 'Médico de cabecera' },
            { id: '2', name: 'Farmacia Central', phone: '+1234567892', relationship: 'pharmacy', notes: 'Farmacia más cercana' }
        ],
        family: [
            { id: '1', name: 'Carlos González', phone: '+1234567893', relationship: 'family', notes: 'Puede ver reportes' }
        ]
    },
    patient: {
        name: 'Usuario Demo',
        age: '65',
        conditions: 'Diabetes tipo 2, Hipertensión'
    }
};

let currentFilter = 'all';
let currentContactType = 'emergency';

// VERIFICACIÓN INICIAL
debugLog('JavaScript cargado correctamente');

// Inicialización
function init() {
    debugLog('Iniciando aplicación...');
    
    try {
        updateTodayView();
        updateMedicinesView();
        updateReportsView();
        updateProfileView();
        updateTodayDate();
        loadSavedData();
        setupEventListeners();
        
        debugLog('✅ Aplicación inicializada correctamente');
        
        // Verificar que los botones existen
        setTimeout(() => {
            const addBtn = document.querySelector('.add-btn');
            const navBtns = document.querySelectorAll('.nav-btn');
            
            debugLog(`Botones encontrados: ${navBtns.length} navegación, ${addBtn ? '1 agregar' : '0 agregar'}`);
            
        }, 1000);
        
    } catch (error) {
        debugLog(`❌ Error en inicialización: ${error.message}`);
        console.error('Error:', error);
    }
}

// Navegación
function switchSection(sectionName) {
    debugLog(`Cambiando a sección: ${sectionName}`);
    
    try {
        // Actualizar botones de navegación
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`[onclick="switchSection('${sectionName}')"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // Mostrar sección
        document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
        const targetSection = document.getElementById(`${sectionName}-section`);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Actualizar contenido específico
        switch(sectionName) {
            case 'today':
                updateTodayView();
                break;
            case 'medicines':
                updateMedicinesView();
                break;
            case 'reports':
                updateReportsView();
                break;
            case 'profile':
                updateProfileView();
                break;
        }
        
        debugLog(`✅ Sección ${sectionName} activada`);
        
    } catch (error) {
        debugLog(`❌ Error en switchSection: ${error.message}`);
    }
}

// Vistas
function updateTodayView() {
    debugLog('Actualizando vista de hoy...');
    
    const taken = appData.medications.filter(m => m.taken).length;
    const pending = appData.medications.filter(m => !m.taken).length;
    
    const takenEl = document.getElementById('taken-count');
    const pendingEl = document.getElementById('pending-count');
    const missedEl = document.getElementById('missed-count');
    
    if (takenEl) takenEl.textContent = taken;
    if (pendingEl) pendingEl.textContent = pending;
    if (missedEl) missedEl.textContent = 0;
    
    const container = document.getElementById('today-medications-list');
    const todaysMeds = appData.medications.filter(m => m.frequency === 'daily');
    
    if (container) {
        container.innerHTML = todaysMeds.map(med => `
            <div class="medication-card ${med.taken ? 'taken' : ''}" data-id="${med.id}">
                <div class="med-info">
                    <div class="med-name">${med.name}</div>
                    <div class="med-dose">${med.dose} - ${med.instructions}</div>
                    <div class="med-time">${med.time}</div>
                </div>
                ${!med.taken ? `<button class="btn btn-success" onclick="takeMedication('${med.id}')">
                    <i class="fas fa-check"></i> Tomar Ahora
                </button>` : ''}
            </div>
        `).join('');
    }
}

function updateReportsView() {
    debugLog('Actualizando reportes...');
    updateAdherenceText();
    
    const weeklyContainer = document.getElementById('weekly-stats');
    const weekStats = generateWeeklyStats();
    if (weeklyContainer) {
        weeklyContainer.innerHTML = weekStats.map(day => `
            <div style="display:inline-block;background:#f3f4f6;padding:15px;margin:5px;border-radius:10px;text-align:center;min-width:100px">
                <div style="font-weight:bold;color:#2563EB">${day.day}</div>
                <div style="font-size:1.5em;color:${day.color}">${day.percentage}%</div>
                <div style="font-size:0.9em;color:#666">${day.taken}/${day.total}</div>
            </div>
        `).join('');
    }
}

function updateAdherenceText() {
    const container = document.getElementById('adherence-text');
    
    if (container) {
        const weekDays = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        const adherenceText = weekDays.map((day, index) => {
            const taken = Math.floor(Math.random() * 4);
            const total = 3;
            const percentage = Math.round((taken / total) * 100);
            
            return `${day} ${percentage}% ${taken}/${total}`;
        }).join('<br>');
        
        container.innerHTML = `
            <div style="background:#f8fafc;padding:25px;border-radius:12px;border-left:4px solid #2563EB">
                <div style="font-size:1.2em;line-height:1.8;color:#1f2937">
                    ${adherenceText}
                </div>
            </div>
        `;
    }
}

function updateTodayDate() {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateEl = document.getElementById('today-date');
    if (dateEl) {
        dateEl.textContent = today.toLocaleDateString('es-ES', options);
    }
}

function updateMedicinesView() {
    debugLog('Actualizando vista de medicamentos...');
    // Implementación simplificada para diagnóstico
}

function updateProfileView() {
    debugLog('Actualizando vista de perfil...');
    // Implementación simplificada para diagnóstico
}

// Funcionalidades
function takeMedication(id) {
    debugLog(`Tomando medicamento: ${id}`);
    
    const med = appData.medications.find(m => m.id === id);
    if (med && !med.taken) {
        med.taken = true;
        med.takenAt = new Date().toLocaleTimeString();
        
        showToast(`¡Excelente! Has tomado ${med.name}`, 'success');
        
        updateTodayView();
        saveData();
    }
}

function filterMedications(filter) {
    debugLog(`Filtrando medicamentos: ${filter}`);
    currentFilter = filter;
}

function showAddMedicationModal() {
    debugLog('Mostrando modal de agregar medicamento');
    const modal = document.getElementById('add-medication-modal');
    if (modal) {
        modal.classList.add('active');
    }
}

function showAddContactModal(type) {
    debugLog(`Mostrando modal de agregar contacto: ${type}`);
    currentContactType = type;
    const modal = document.getElementById('add-contact-modal');
    if (modal) {
        modal.classList.add('active');
    }
}

function showSOSModal() {
    debugLog('Mostrando modal SOS');
    const modal = document.getElementById('sos-modal');
    if (modal) {
        modal.classList.add('active');
    }
}

function closeModal(modalId) {
    debugLog(`Cerrando modal: ${modalId}`);
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

function switchTab(tabName) {
    debugLog(`Cambiando pestaña: ${tabName}`);
    // Implementación simplificada para diagnóstico
}

function callContact(phone) {
    debugLog(`Llamando a: ${phone}`);
    if (confirm(`¿Llamar a ${phone}?`)) {
        window.location.href = `tel:${phone}`;
    }
}

function callEmergency(number) {
    debugLog(`Llamando emergencia: ${number}`);
    if (confirm(`¿Llamar al ${number}?`)) {
        window.location.href = `tel:${number}`;
    }
}

// Utilidades
function generateWeeklyStats() {
    const days = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
    return days.map((day) => {
        const taken = Math.floor(Math.random() * 4);
        const total = 3;
        const percentage = Math.round((taken / total) * 100);
        let color = '#10b981';
        if (percentage < 50) color = '#dc2626';
        else if (percentage < 80) color = '#f59e0b';
        
        return { day, taken, total, percentage, color };
    });
}

function showToast(message, type = 'success') {
    debugLog(`Mostrando toast: ${message}`);
    
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function saveData() {
    debugLog('Guardando datos...');
    try {
        localStorage.setItem('meds-app-complete', JSON.stringify(appData));
        debugLog('✅ Datos guardados');
    } catch (error) {
        debugLog(`❌ Error guardando: ${error.message}`);
    }
}

function loadSavedData() {
    debugLog('Cargando datos...');
    try {
        const saved = localStorage.getItem('meds-app-complete');
        if (saved) {
            appData = JSON.parse(saved);
            debugLog('✅ Datos cargados');
        } else {
            debugLog('ℹ️ No hay datos guardados');
        }
    } catch (error) {
        debugLog(`❌ Error cargando: ${error.message}`);
    }
}

// Event Listeners
function setupEventListeners() {
    debugLog('Configurando event listeners...');
    
    try {
        // Formulario de medicamento
        const medicationForm = document.getElementById('medication-form');
        if (medicationForm) {
            medicationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                debugLog('Formulario de medicamento enviado');
                // Lógica del formulario
                this.reset();
            });
        }
        
        // Cerrar modales al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    debugLog('Modal cerrado por clic fuera');
                }
            });
        });
        
        debugLog('✅ Event listeners configurados');
        
    } catch (error) {
        debugLog(`❌ Error configurando eventos: ${error.message}`);
    }
}

// Verificación de funciones globales
window.addEventListener('load', function() {
    debugLog('✅ Página cargada completamente');
    
    // Verificar que las funciones globales están disponibles
    const functionsToCheck = [
        'switchSection', 'takeMedication', 'showAddMedicationModal', 
        'showSOSModal', 'closeModal', 'showAddContactModal'
    ];
    
    functionsToCheck.forEach(funcName => {
        if (typeof window[funcName] === 'function') {
            debugLog(`✅ Función ${funcName} disponible`);
        } else {
            debugLog(`❌ Función ${funcName} NO disponible`);
        }
    });
});

// Inicializar aplicación
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>
</body>
</html>
